# 架构改造方案：多队列性能优化

## 1. 问题背景

### 1.1 性能瓶颈

在对应用进行压力测试时，我们发现当前架构下的任务处理速率约为 **630次/分钟**，这远低于各个下载任务类型合计的理论API速率上限（约1200次/分钟）。

### 1.2 根本原因分析

经过分析，我们定位到性能瓶颈的根本原因在于**所有任务（无论快慢）都在争抢同一个消费者worker池的资源**。

当前的实现中，一个worker在完成一个快速的下载任务（`download_task`）后，会立即被分配去执行一个慢速的、阻塞的数据保存任务（`process_data_task`）。由于数据保存任务需要等待数据库写入，速度很慢，这导致了整个worker池被迅速占满并普遍处于等待状态。最终，没有空闲的worker来处理新的下载任务，使得系统的整体吞吐能力被数据库I/O严重拖累。

## 2. 解决方案：隔离任务队列

为了解决此问题，我们提出采用**多队列、多消费者**的架构，将不同性质的任务进行隔离。

1.  **快速任务队列 (`huey_fast`)**: 用于处理耗时短、I/O密集的任务，例如 `download_task`。为其分配一个拥有大量worker（如50个）的专属消费者进程，以实现高并发。

2.  **慢速任务队列 (`huey_slow`)**: 用于处理耗时较长、有阻塞的CPU或磁盘密集型任务，例如 `process_data_task`。为其分配一个只有少量worker（如4个）的专属消费者进程，因为过多的worker在此类任务上只会加剧资源（如数据库锁）的竞争。

通过这种方式，慢速任务的执行将不会再占用快速任务的处理资源，从而将瓶颈隔离，使下载任务的处理速度可以达到其理论上限。

## 3. 原型验证

我们已经通过一个原型成功验证了该方案的可行性。原型测试结果表明，在使用独立队列和独立消费者进程后，快速任务队列的吞吐量完全不受慢速队列的影响，达到了其理论上的最大值。

> [!IMPORTANT]
> **该原型的完整实现可作为本次架构改造的直接参考。**
> **源码路径: `examples/huey_multi_instance_prototype/`**

## 4. 具体改造步骤

将原型中验证过的模式应用到主应用中，需要修改以下部分：

1.  **创建多Huey实例**
    -   **文件**: `src/neo/configs/huey_config.py`
    -   **操作**: 仿照原型中的 `config.py`，创建两个独立的Huey实例，例如 `huey_fast` 和 `huey_slow`，并使用不同的SQLite数据库文件路径。

2.  **任务分类与注册**
    -   **文件**: `src/neo/tasks/huey_tasks.py`
    -   **操作**:
        -   使用 `@huey_fast.task()` 来装饰 `download_task`。
        -   使用 `@huey_slow.task()` 来装饰 `process_data_task`。

3.  **改造任务调用逻辑**
    -   **文件**: `src/neo/tasks/huey_tasks.py`
    -   **操作**: 在 `download_task` 函数的末尾，需要修改任务的链接方式。不再使用 `.then()`，而是手动调用 `process_data_task`，将下载好的数据作为参数传递过去。参考原型 `tasks.py`：
        ```python
        # 在 download_task 的末尾
        # ...下载数据到 result ...
        process_data_task(task_type=..., symbol=..., data_frame=result.to_dict("records"))
        ```

4.  **创建统一入口点**
    -   **文件**: 在 `src/neo/` 下创建一个新的入口文件，例如 `huey_main.py`。
    -   **操作**: 在此文件中，仿照原型的 `main.py`，同时导入两个Huey实例和 `tasks.py` 模块，以确保所有任务都能被正确注册。

5.  **更新消费者启动脚本**
    -   **文件**: 修改现有的 `run_dp_and_monitor.sh` 或创建新的脚本。
    -   **操作**: 需要启动两个独立的 `huey_consumer` 进程，分别指向 `huey_main.py` 中不同的Huey实例，并为其分配合适的worker数量。

## 5. 预期收益

-   **性能提升**: 应用的下载任务吞吐量将摆脱数据库写入的瓶颈，预计能从630次/分钟提升到接近理论上限的1200次/分钟。
-   **系统稳定性**: 不同类型任务的隔离将使系统更加健壮，某一类任务的延迟或失败不会影响到另一类任务的正常执行。
