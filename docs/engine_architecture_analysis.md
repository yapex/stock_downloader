# DownloadEngine 架构分析文档

## 概述

`DownloadEngine` 是股票数据下载系统的核心组件，采用生产者-消费者模式实现高效的并发数据下载和存储。该引擎负责协调任务调度、数据获取、批量处理和持久化存储的整个流程。

## 核心架构

### 1. 整体设计模式

- **生产者-消费者模式**: 使用队列解耦数据获取和存储操作
- **分阶段处理**: 系统表任务优先，业务表任务并行
- **批量处理**: 数据批量获取和批量写入，提高性能
- **线程池管理**: 动态管理生产者和消费者线程

### 2. 主要组件

#### 2.1 DownloadEngine (核心引擎)
- **职责**: 任务调度、流程控制、资源管理
- **依赖**: TushareFetcher (数据获取)、DuckDBStorage (数据存储)
- **配置**: 支持线程数、队列大小、批量大小等参数配置

#### 2.2 Producer (生产者)
- **职责**: 从任务队列获取任务，调用API获取数据，将数据放入数据队列
- **特点**: 多线程并行，共享TushareFetcher实例
- **限流**: 通过TushareFetcher的rate limiting控制API调用频率

#### 2.3 ConsumerPool (消费者池)
- **职责**: 管理多个消费者线程，从数据队列获取数据并批量写入数据库
- **特点**: 支持动态扩缩容、批量处理、失败重试
- **优化**: 本地缓存、定时刷新、延迟初始化

#### 2.4 队列系统
- **task_queue**: 任务队列，存储待处理的DownloadTask
- **data_queue**: 数据队列，存储从API获取的DataBatch

## 核心流程

### 1. 初始化阶段

```
1. 解析配置文件
2. 初始化Fetcher和Storage实例
3. 设置队列和线程池参数
4. 创建任务队列和数据队列
5. 初始化消费者池
```

### 2. 任务发现与构建

```
1. 从配置中获取启用的任务
2. 分离系统表任务(stock_list)和业务表任务
3. 准备目标股票列表:
   - 配置指定: 使用配置中的股票代码列表
   - "all": 从数据库查询所有股票代码
4. 批量构建DownloadTask:
   - 系统任务: 单个任务，高优先级
   - 业务任务: 每个股票×每个任务类型，普通优先级
   - 日期范围优化: 批量查询最新日期，避免重复下载
```

### 3. 分阶段执行

#### 阶段1: 系统表任务处理
```
1. 处理stock_list等系统级任务
2. 使用单线程生产者确保数据一致性
3. 高优先级处理，为后续业务任务提供基础数据
```

#### 阶段2: 业务表任务处理
```
1. 启动多个生产者线程并行处理
2. 生产者数量根据任务数量动态调整
3. 消费者池并行处理数据写入
4. 实时监控队列状态和进度
```

### 4. 数据流转

```
DownloadTask → task_queue → Producer → API调用 → DataBatch → data_queue → Consumer → DuckDB
```

## 关键特性

### 1. 性能优化

- **批量操作**: 批量构建任务、批量查询最新日期、批量写入数据库
- **并发控制**: 多生产者并行获取数据，多消费者并行写入
- **队列缓冲**: 使用有界队列平衡内存使用和吞吐量
- **连接复用**: 生产者共享Fetcher实例，消费者延迟初始化Storage连接

### 2. 可靠性保障

- **失败重试**: 任务级别的重试机制，支持最大重试次数配置
- **死信队列**: 失败任务记录到死信文件，便于问题排查
- **优雅关闭**: 确保队列中的数据完全处理后再关闭
- **异常处理**: 完善的异常捕获和日志记录

### 3. 监控与统计

- **进度跟踪**: 实时显示下载进度和处理状态
- **性能统计**: 记录处理时间、成功/失败数量等指标
- **资源监控**: 队列大小、线程状态等运行时信息

### 4. 灵活配置

- **线程数配置**: 支持生产者和消费者线程数独立配置
- **队列大小**: 可配置任务队列和数据队列的容量
- **批量参数**: 支持批量大小和刷新间隔配置
- **重试策略**: 可配置最大重试次数和重试间隔

## 数据模型

### DownloadTask
```python
@dataclass
class DownloadTask:
    symbol: str              # 股票代码
    task_type: TaskType      # 任务类型(daily/daily_basic/financials/stock_list)
    params: Dict[str, Any]   # 任务参数(包含日期范围、配置等)
    priority: Priority       # 优先级(HIGH/NORMAL/LOW)
    retry_count: int         # 重试次数
    max_retries: int         # 最大重试次数
    task_id: str            # 唯一标识
    created_at: datetime     # 创建时间
```

### DataBatch
```python
@dataclass
class DataBatch:
    batch_id: str           # 批次唯一标识
    data_type: str          # 数据类型
    symbol: str             # 股票代码
    data: pd.DataFrame      # 数据内容
    metadata: Dict[str, Any] # 元数据
    created_at: datetime    # 创建时间
```

## 配置参数

### 引擎配置
```yaml
downloader:
  max_producers: 4        # 最大生产者线程数
  max_consumers: 2        # 最大消费者线程数
  producer_queue_size: 1000  # 任务队列大小
  data_queue_size: 500    # 数据队列大小
  
consumer:
  batch_size: 100         # 批量写入大小
  flush_interval: 30.0    # 刷新间隔(秒)
  max_retries: 3          # 最大重试次数
```

## 扩展点

### 1. 任务类型扩展
- 通过TaskType枚举添加新的任务类型
- 实现对应的数据获取和处理逻辑

### 2. 存储后端扩展
- 实现Storage接口支持其他数据库
- 支持多存储后端并行写入

### 3. 监控扩展
- 集成外部监控系统
- 添加自定义指标和告警

### 4. 调度策略扩展
- 实现优先级队列
- 支持任务依赖关系
- 添加负载均衡策略

## 性能考虑

### 1. 内存管理
- 队列大小限制防止内存溢出
- 及时释放处理完成的数据
- 使用流式处理大数据集

### 2. 并发控制
- 合理设置线程数避免过度竞争
- 使用线程安全的数据结构
- 避免死锁和竞态条件

### 3. I/O优化
- 批量数据库操作减少I/O次数
- 异步处理提高吞吐量
- 连接池复用减少连接开销

## 故障处理

### 1. 常见故障
- API限流: 通过rate limiting和重试机制处理
- 网络异常: 自动重试和降级处理
- 数据库连接失败: 连接重建和事务回滚
- 内存不足: 队列背压和流量控制

### 2. 恢复机制
- 任务重试: 失败任务自动重新调度
- 检查点: 记录处理进度支持断点续传
- 降级模式: 在资源不足时降低并发度

## 总结

`DownloadEngine` 通过生产者-消费者模式实现了高效、可靠的股票数据下载系统。其分阶段处理、批量优化、并发控制等设计确保了系统的性能和稳定性。模块化的架构使得系统具有良好的可扩展性和可维护性。