# tqdm 进度条演示

本目录包含了使用 tqdm 进度条替代原始打印模式的演示代码，展示了如何在异步任务处理中集成美观的进度显示。

## 文件说明

### 核心文件

- `amain_tqdm.py` - 基础 tqdm 进度条演示
- `tasks_tqdm.py` - 支持进度显示的任务函数
- `advanced_progress_demo.py` - 高级进度条演示（嵌套、错误处理、流水线）
- `config.py` - Huey 配置（与原版相同）

### 原始文件（对比参考）

- `amain.py` - 原始的打印模式演示
- `tasks.py` - 原始的任务函数

## 功能特性

### 基础进度条功能

1. **任务提交进度** - 显示任务提交的实时进度
2. **任务执行进度** - 显示任务执行完成的实时进度
3. **并发执行监控** - 实时监控并发任务的完成情况
4. **进度估算** - 基于时间的进度估算和显示

### 高级进度条功能

1. **嵌套进度条** - 多层级的进度显示（组级别 + 任务级别）
2. **错误处理进度** - 带错误统计的进度条
3. **流水线进度** - 多阶段处理的进度跟踪
4. **实时状态更新** - 动态更新进度条的状态信息

## 运行演示

### 基础演示

```bash
# 进入项目根目录
cd /Users/yapex/workspace/stock_downloader

# 运行基础 tqdm 演示
uv run python examples/asyncio_prototype/amain_tqdm.py
```

### 高级演示

```bash
# 运行高级进度条演示
uv run python examples/asyncio_prototype/advanced_progress_demo.py
```

### 对比原始版本

```bash
# 运行原始打印模式演示（对比参考）
uv run python examples/asyncio_prototype/amain.py
```

## 演示内容

### 基础演示 (`amain_tqdm.py`)

1. **链式任务进度条**
   - 任务提交进度条
   - 任务执行进度条
   - 实时显示当前处理的股票代码
   - 成功率统计

2. **并发任务进度条**
   - 快速任务提交
   - 并发执行监控
   - 性能统计（并发效率计算）

3. **长时间任务监控**
   - 基于时间估算的进度条
   - 实时显示已用时间

### 高级演示 (`advanced_progress_demo.py`)

1. **嵌套进度条演示**
   - 外层：股票组处理进度
   - 内层：单个组内股票处理进度
   - 多层级状态显示

2. **错误处理进度条**
   - 不同失败率的任务测试
   - 实时错误统计
   - 错误详情展示

3. **流水线进度条**
   - 多阶段处理：下载 -> 分析 -> 报告
   - 每个阶段的独立进度跟踪
   - 整体流水线进度显示

## 技术特点

### tqdm 集成优势

1. **视觉效果** - 美观的进度条替代简单的文本输出
2. **实时更新** - 动态显示任务进度和状态信息
3. **多层显示** - 支持嵌套进度条，适合复杂的任务结构
4. **性能友好** - 低开销的进度显示，不影响任务执行性能

### 异步兼容性

1. **asyncio 集成** - 使用 `tqdm.asyncio` 模块，完美支持异步操作
2. **非阻塞更新** - 进度条更新不会阻塞异步任务执行
3. **并发安全** - 支持多个并发任务同时更新进度

### 错误处理

1. **异常捕获** - 优雅处理任务执行中的异常
2. **错误统计** - 实时统计成功/失败任务数量
3. **状态显示** - 在进度条中显示错误信息

## 代码结构

### 任务函数设计

```python
@huey.task()
def download_task_with_progress(symbol: str) -> Dict[str, Any]:
    """支持进度显示的下载任务"""
    # 分阶段执行，便于进度跟踪
    stages = [
        ("连接服务器", 0.2),
        ("获取数据", 0.6),
        ("验证数据", 0.15),
        ("格式化数据", 0.05)
    ]
    # ... 实现细节
```

### 进度条使用模式

```python
# 基础进度条
with tqdm(total=len(tasks), desc="执行任务", unit="task") as pbar:
    for coro in asyncio.as_completed(task_coros):
        result = await coro
        pbar.set_postfix_str(f"完成: {result['symbol']}")
        pbar.update(1)

# 嵌套进度条
with tqdm(total=len(groups), desc="处理组", position=0) as group_pbar:
    for group in groups:
        with tqdm(total=len(group), desc="处理任务", position=1, leave=False) as task_pbar:
            # 内层任务处理
            pass
```

## 性能对比

| 特性 | 原始打印模式 | tqdm 进度条模式 |
|------|-------------|----------------|
| 视觉效果 | 简单文本 | 美观进度条 |
| 实时反馈 | 离散输出 | 连续更新 |
| 进度估算 | 无 | 支持 |
| 嵌套显示 | 困难 | 原生支持 |
| 错误处理 | 基础 | 增强 |
| 性能开销 | 极低 | 低 |

## 最佳实践

1. **合理设置进度条参数**
   - `desc`: 清晰的描述信息
   - `unit`: 合适的单位（task, item, %等）
   - `position`: 嵌套时的位置控制

2. **状态信息更新**
   - 使用 `set_postfix_str()` 显示当前状态
   - 及时更新进度和状态信息

3. **异常处理**
   - 在进度条中显示错误信息
   - 确保异常不会中断进度显示

4. **性能考虑**
   - 避免过于频繁的进度更新
   - 合理设置更新间隔

## 扩展建议

1. **集成到主项目** - 将 tqdm 进度条集成到主要的数据下载和处理流程中
2. **自定义进度条** - 根据具体需求定制进度条样式和行为
3. **日志集成** - 将进度信息同时记录到日志文件中
4. **Web界面** - 考虑将进度信息通过 WebSocket 推送到 Web 界面